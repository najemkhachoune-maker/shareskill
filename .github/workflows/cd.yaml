name: CD Deploy Infra + Chart (Demo Mode)

on:
  workflow_dispatch:
  push:
    branches: ["develop", "main"]

jobs:
  checkov:
    runs-on: ubuntu-latest
    timeout-minutes: 2
    steps:
      - name: ğŸ” Checkov â€“ Terraform Security Scan
        run: |
          echo "Running Checkov scan on Terraform files..."
          sleep 5
          echo "âœ” No critical misconfigurations found"

  gitleaks:
    runs-on: ubuntu-latest
    timeout-minutes: 2
    steps:
      - name: ğŸ” Gitleaks â€“ Secrets Detection
        run: |
          echo "Scanning repository for secrets..."
          sleep 5
          echo "âœ” No secrets detected"

  terraform:
    needs: [checkov, gitleaks]
    runs-on: ubuntu-latest
    timeout-minutes: 3
    steps:
      - name: ğŸŒ Terraform Init
        run: |
          echo "Initializing Terraform backend..."
          sleep 5
          echo "âœ” Terraform initialized successfully"

      - name: ğŸš€ Terraform Apply
        run: |
          echo "Applying Terraform infrastructure..."
          sleep 8
          echo "âœ” Infrastructure deployed successfully"

  helm-deploy:
    needs: terraform
    runs-on: ubuntu-latest
    timeout-minutes: 4
    steps:
      - name: â˜¸ï¸ Kubernetes & Helm Setup
        run: |
          echo "Configuring kubectl and Helm..."
          sleep 5
          echo "âœ” Kubernetes context configured"

      - name: ğŸ”‘ Create ImagePullSecret
        run: |
          echo "Creating Docker registry secret..."
          sleep 4
          echo "âœ” ImagePullSecret created"

      - name: ğŸ“¦ Helm Upgrade / Install
        run: |
          echo "Deploying microservices with Helm..."
          sleep 8
          echo "âœ” Helm deployment successful"

      - name: â³ Wait for Rollout
        run: |
          echo "Waiting for microservices rollout..."
          for svc in api-gateway auth-service notification-service chat-service; do
            echo "âœ” $svc successfully rolled out"
            sleep 3
          done

      - name: âœ… Deployment Status
        run: |
          echo "ğŸ‰ All services are up and running"
          echo "Pipeline completed successfully"
