name: CD Deploy Infra + Chart (Demo Mode)

on:
  workflow_dispatch:
  push:
    branches: ["develop", "main"]

jobs:
  checkov:
    runs-on: [self-hosted, linux, x64]
    continue-on-error: true
    timeout-minutes: 2
    steps:
      - name: ğŸ” Checkov â€“ Terraform Security Scan
        run: |
          echo "Running Checkov scan..."
          sleep 3
          echo "âœ” Scan completed"

  gitleaks:
    runs-on: [self-hosted, linux, x64]
    continue-on-error: true
    timeout-minutes: 2
    steps:
      - name: ğŸ” Gitleaks â€“ Secrets Detection
        run: |
          echo "Running Gitleaks scan..."
          sleep 3
          echo "âœ” No secrets detected"

  terraform:
    needs: [checkov, gitleaks]
    runs-on: [self-hosted, linux, x64]
    timeout-minutes: 3
    steps:
      - name: ğŸŒ Terraform Init
        run: |
          echo "Initializing Terraform..."
          sleep 4
          echo "âœ” Terraform initialized"

      - name: ğŸš€ Terraform Apply
        run: |
          echo "Applying infrastructure..."
          sleep 6
          echo "âœ” Infrastructure deployed"

  helm-deploy:
    needs: terraform
    runs-on: [self-hosted, linux, x64]
    timeout-minutes: 4
    steps:
      - name: â˜¸ï¸ Kubernetes & Helm Setup
        run: |
          echo "Setting up kubectl & helm..."
          sleep 4
          echo "âœ” Context ready"

      - name: ğŸ“¦ Helm Deployment
        run: |
          echo "Deploying microservices..."
          sleep 6
          echo "âœ” Helm deployment successful"

      - name: âœ… Final Status
        run: |
          echo "ğŸ‰ All services deployed successfully"
