CREATE TABLE RESOURCES (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  name VARCHAR(200) NOT NULL,
  timezone VARCHAR(64) NOT NULL,
  created_at TIMESTAMP WITH TIME ZONE NOT NULL
);

CREATE TABLE BOOKINGS (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  resource_id BIGINT NOT NULL,
  customer_name VARCHAR(200) NOT NULL,
  start_at TIMESTAMP WITH TIME ZONE NOT NULL,
  end_at TIMESTAMP WITH TIME ZONE NOT NULL,
  status VARCHAR(20) NOT NULL,
  created_at TIMESTAMP WITH TIME ZONE NOT NULL,
  updated_at TIMESTAMP WITH TIME ZONE NOT NULL,
  CONSTRAINT fk_bookings_resource FOREIGN KEY (resource_id) REFERENCES RESOURCES(id)
);

CREATE INDEX idx_bookings_resource_time ON BOOKINGS(resource_id, start_at, end_at);

CREATE TABLE BOOKING_SLOTS (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  booking_id BIGINT NOT NULL,
  resource_id BIGINT NOT NULL,
  slot_start_at TIMESTAMP WITH TIME ZONE NOT NULL,
  CONSTRAINT fk_slots_booking FOREIGN KEY (booking_id) REFERENCES BOOKINGS(id) ON DELETE CASCADE,
  CONSTRAINT fk_slots_resource FOREIGN KEY (resource_id) REFERENCES RESOURCES(id),
  CONSTRAINT uq_resource_slot_start UNIQUE (resource_id, slot_start_at)
);

CREATE INDEX idx_slots_resource_start ON BOOKING_SLOTS(resource_id, slot_start_at);